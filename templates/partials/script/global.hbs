{{!< default}}
{{!-- 
/**
 * Uncertainty Project
 * Developed by Engagement Lab, 2016
 * ==============
 * 
 * Script include for global logic
 * ==========
 */
--}}

<script type="text/javascript">

	$(document).ready(function() {

		var windowsize = $(window).width(),
			bodysize = $('#wrapper').width(),
			wrapperLeft = $('#wrapper').offset().left,
			extraWindow = (windowsize - bodysize)/2;

		var imagesLoaded = function(parentElem, callback) {

		  parentElem.find('img').last().on('load', function() {

		    // Image loaded, callback fires
		    callback();

		  })
		  .each(function() {

		    // Force image to dispatch 'load' (cache workaround)
		    if(this.complete) $(this).load();

		  });

		};
		
		var setAbsolutes = function(absolutes) {

			if (absolutes.length == 0) {
				return;
			}

			var length = absolutes.length;

			_.each(absolutes, function(item, ind) {

				var position = {};

				// Check current positions
				if ($(item).css('left') !== undefined && $(item).css('left') !== null && $(item).css('left') !== 'auto' && $(item).css('left')) {
					position.left = $(item).css('left');
				}

				if ($(item).css('right') !== undefined &&$(item).css('right') !== null && $(item).css('right') !== 'auto' && $(item).css('right')) {
					position.right = $(item).css('right');
				}

				// If left, set it. 
				if (position.left){
					$(item).css('left', wrapperLeft);
				}
				//If right, set it.
				if (position.right) {
					position.right =+ extraWindow;
					$(item).css('right', position.right);
				}

				if (ind == length - 1) {

					// {{#ifeq section 'portfolio'}}
					// $('#project-grid').isotope('layout');
					// {{/ifeq}}

				}

			});

		};

		// Locally-scoped methods
		var findAbsolutes = function() {

			windowsize = $(window).width(),
			bodysize = $('#wrapper').width(),
			wrapperLeft = $('#wrapper').offset().left,
			extraWindow = (windowsize - bodysize)/2;

			// Project Grid Sizing
			imagesLoaded($('#project-grid'), function() {
				if (windowsize <= 380) {
					_.each($('.project-info'), function(info){
						var height = $(info).closest('.project-item').height();
						$(info).css('height', height + 'px');
					});
				}
			});

			// Remove empty paragraph tags from markdown
			_.each($('p'), function(p) {
				if ($(p).html().length <= 0)
					p.remove();
			});

			// Get all absolutely-positioned elements
			var outerAbsolutes = 
			$('#wrapper :not(#sidebar-wrapper)')
			.filter(function(){
			  return ($(this).css('position') == 'absolute');
			});

			setAbsolutes(outerAbsolutes);

		};

		findAbsolutes();

		$(window).on('resize', function () {

			// Adjust absolutely-position elements for desktop only
			findAbsolutes();

		});

		$('#menu-toggle').on('click', function(evt) {

			$(this).hide();

			$('#sidebar-wrapper').animate({
				right: '0px'
			}, 500);

			$('#menu-close').on('click', function(evt) {
				$('#menu-toggle').show();

				$('#sidebar-wrapper').animate({
					right: '100%'
				}, 500);

			});

		});



		{{#ifeq section 'portfolio'}}

			var filtered = 0;
			var filters = [];
			var container = $('#project-grid');


			$('.tag').on('click', function() {
				
				$(this).toggleClass('is-checked');

				applyFilter(this, $(this).hasClass('is-checked'));
				displayChecked(this, $(this).hasClass('is-checked'));
			});

			$('#project-grid').imagesLoaded( function() {
				
				var $filtered = $(container).isotope({
				    itemSelector: '.project-item',
				    filter: '*', 
				    masonry: {
					  gutter: 10
					}
				});

				$('.clear-all').trigger('click');

				var num = $filtered.isotope('getFilteredItemElements').length;
				checkFiltered(num, container, $filtered);
			});


			function displayChecked (elem, selected) {

				var selector = $(elem);
				var option = selector.data('filter-value');

				if ($('.filters-chosen').find('div').length > 0)
					$('.filters-chosen').css('display', 'inline-block');
				else
					$('.filters-chosen').hide();

			}

			function checkFiltered (num, container, filtered) {

				filtered.isotope('layout');

				filtered += num;
				
				if ( filtered === 0 ) {
				  $('.no-filtered-visible').show();
				} else {
					$('.no-filtered-visible').hide();
				}

			}
		    
		    function applyFilter(elem, selected) {

		    	filtered = 0;
					
			    var selector = $(elem);
			    			    
				if (selected) {
					if (selector.data('filter-value').length >= 1)
				    filters.push('.' + selector.data('filter-value').toString());
				} else {
					var index = filters.indexOf('.' + selector.data('filter-value').toString());
					if (index > -1) {
						filters.splice(index, 1);
					}
				}
			    			    
			    var filterStr = filters.join('');
			    
				var $filtered = $(container).isotope({ 
					filter: filterStr, 
					itemSelector: '.project-item' 
				});
				var num = $filtered.isotope('getFilteredItemElements').length;
				checkFiltered(num, container, $filtered);   

			}

			$(".clear-all").on('click', function() {
				
				filters = [];
				$(container).isotope({
			        filter: '*' 

				});
					
				$('.is-checked').removeClass('is-checked');
				$('.all-options').addClass('is-checked');
				$('.all-options').each(function(i, obj){
					applyFilter(this);
					displayChecked(this);
				});

			});

		{{/ifeq}}


	});
	
</script>